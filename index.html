<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6273611184935541"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Hold Challenge: Definitive Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --bg-color: #2c3e50;
            --container-bg: #34495e;
            --text-color: #ecf0f1;
            --accent-color: #3498db;
            --perfect-color: #2ecc71;
            --great-color: #a5d6a7;
            --good-color: #f1c40f;
            --close-color: #e67e22;
            --miss-color: #e74c3c;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            user-select: none;
            transition: background-color 0.3s ease;
        }

        body.holding {
            background-color: #27374a;
        }

        #game-container {
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }

        h1 {
            margin-top: 0;
            color: var(--accent-color);
        }

        #stage-display {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-color);
            min-height: 2rem;
        }
        
        #ui-feedback {
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #target-display {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--text-color);
            opacity: 1;
            transition: opacity 0.4s ease-out;
        }
        
        #target-display.fading-out,
        #progress-container.fading-out {
            opacity: 0;
        }

        #instructions {
            font-size: 1.1rem;
            opacity: 0.8;
            min-height: 2.5rem;
        }

        /* --- THE CHANGE IS HERE --- */
        #progress-container {
            position: relative;
            width: 100%;
            height: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
            display: block; /* Changed from 'none' to make it visible by default */
            transition: opacity 0.4s ease-out;
            opacity: 1;
        }

        #progress-bar {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background-color: var(--accent-color);
            border-radius: 5px;
        }
        
        #progress-marker {
            position: absolute;
            top: -15px;
            left: 0%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid var(--perfect-color);
        }

        #result-display {
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.2rem;
            line-height: 1.6;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .perfect { color: var(--perfect-color); border-color: var(--perfect-color); }
        .great { color: var(--great-color); border-color: var(--great-color); }
        .good { color: var(--good-color); border-color: var(--good-color); }
        .close { color: var(--close-color); border-color: var(--close-color); }
        .miss { color: var(--miss-color); border-color: var(--miss-color); }

        #action-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: var(--accent-color);
            color: white;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #action-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <h1>Time Hold Challenge</h1>
        <p id="stage-display"></p>
        
        <div id="ui-feedback">
            <h2 id="target-display"></h2>
            <p id="instructions"></p>
            <div id="progress-container">
                <div id="progress-marker"></div>
                <div id="progress-bar"></div>
            </div>
        </div>

        <div id="result-display" class="hidden"></div>
        <button id="action-button" class="hidden">Continue</button>
    </div>

    <script>
        // DOM Elements
        const gameContainer = document.getElementById('game-container');
        const targetDisplay = document.getElementById('target-display');
        const instructions = document.getElementById('instructions');
        const resultDisplay = document.getElementById('result-display');
        const actionButton = document.getElementById('action-button');
        const stageDisplay = document.getElementById('stage-display');
        const body = document.body;
        const uiFeedback = document.getElementById('ui-feedback');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressMarker = document.getElementById('progress-marker');

        // Game State
        let targetTime = 0;
        let startTime = 0;
        let isHolding = false;
        let gameActive = true;
        let lastRoundSuccess = false;
        let currentStageIndex = 0;

        const stages = [
            { name: "Stage 1", min: 1,  max: 3  },
            { name: "Stage 2", min: 3,  max: 5  },
            { name: "Stage 3", min: 5,  max: 10 },
            { name: "Stage 4", min: 10, max: 15 },
            { name: "Stage 5", min: 15, max: 20 }
        ];

        // --- AUDIO SETUP ---
        let audioCtx;
        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'start') { oscillator.frequency.value = 880; oscillator.type = 'sine'; } 
            else if (type === 'end') { oscillator.frequency.value = 440; oscillator.type = 'sine'; } 
            else if (type === 'success') {
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
                oscillator.frequency.value = 523.25; // C5
                const osc2 = audioCtx.createOscillator();
                osc2.frequency.value = 659.25; // E5
                osc2.type = 'sine';
                osc2.connect(gainNode);
                osc2.start();
                osc2.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'miss') { oscillator.frequency.value = 164.81; oscillator.type = 'sawtooth'; }
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }
        function playCloseMissSound() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = 220; oscillator.type = 'triangle';
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        function setupNewRound() {
            if (currentStageIndex >= stages.length) {
                displayOverallWin();
                return;
            }
            const stage = stages[currentStageIndex];

            resultDisplay.classList.add('hidden');
            actionButton.classList.add('hidden');
            uiFeedback.classList.remove('hidden');
            
            // Reset fading classes
            targetDisplay.classList.remove('fading-out');
            progressContainer.classList.remove('fading-out');
            
            gameActive = true;
            isHolding = false;
            
            // Reset progress bar visuals
            progressBar.style.width = '100%';
            progressMarker.style.left = '0%';

            instructions.textContent = "Click and hold on this box for +-0.5s of the target time.";
            stageDisplay.textContent = stage.name;
            targetTime = Math.random() * (stage.max - stage.min) + stage.min;
            targetDisplay.textContent = `${targetTime.toFixed(2)}s`;
        }

        function updateProgress() {
            if (!isHolding) return;

            const elapsedTime = (Date.now() - startTime) / 1000;
            const remainingTime = Math.max(0, targetTime - elapsedTime);
            const progressPercent = Math.min(100, (elapsedTime / targetTime) * 100);

            targetDisplay.textContent = `${remainingTime.toFixed(2)}s`;
            progressBar.style.width = `${100 - progressPercent}%`;
            progressMarker.style.left = `${progressPercent}%`;

            requestAnimationFrame(updateProgress);
        }

        function handleMouseDown(event) {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (gameActive && !isHolding) {
                event.preventDefault();
                isHolding = true;
                startTime = Date.now();
                body.classList.add('holding');
                playSound('start');

                const fadeDurationMs = targetTime * 0.20 * 1000;
                
                // Use a minimal timeout to ensure the fade transition works correctly
                setTimeout(() => {
                    if (!isHolding) return;
                    
                    targetDisplay.style.transitionDuration = `${fadeDurationMs}ms`;
                    targetDisplay.classList.add('fading-out');

                    progressContainer.style.transitionDuration = `${fadeDurationMs}ms`;
                    progressContainer.classList.add('fading-out');
                }, 10);

                requestAnimationFrame(updateProgress);
            }
        }
        
        function handleMouseUp() {
            if (!isHolding) return;
            
            const endTime = Date.now();
            const heldDuration = (endTime - startTime) / 1000;
            
            isHolding = false;
            gameActive = false;
            body.classList.remove('holding');
            
            playSound('end');
            uiFeedback.classList.add('hidden');
            
            showResults(heldDuration);
        }

        function showResults(heldDuration) {
            const difference = Math.abs(targetTime - heldDuration);
            let message = '';
            let celebrationClass = '';
            
            if (difference <= 0.05) {
                celebrationClass = 'perfect';
                message = "PERFECT!";
                playSound('success');
            } else if (difference <= 0.20) {
                celebrationClass = 'great';
                message = "Incredible!";
                playSound('success');
            } else if (difference <= 0.50) {
                celebrationClass = 'good';
                message = "Good try!";
                playCloseMissSound();
            } else if (difference <= 1.0) {
                celebrationClass = 'close';
                message = "So close!";
                playSound('miss');
            } else {
                celebrationClass = 'miss';
                message = "Not quite!";
                playSound('miss');
            }

            lastRoundSuccess = (celebrationClass === 'perfect' || celebrationClass === 'great' || celebrationClass === 'good' );
            
            let resultHeader = lastRoundSuccess ?
                (currentStageIndex === stages.length - 1 ? "<h2>Final Stage Cleared!</h2>" : "<h2>Stage Clear!</h2>") :
                "<h2>Stage Failed!</h2><p>You've been reset to Stage 1.</p>";

            resultDisplay.innerHTML = `
                ${resultHeader}
                Target: <strong>${targetTime.toFixed(2)}s</strong><br>
                Your time: <strong>${heldDuration.toFixed(2)}s</strong><br>
                Difference: <strong>${difference.toFixed(2)}s</strong>
                <p><em>${message}</em></p>
            `;
            
            updateActionButton();
            resultDisplay.className = 'result-display';
            resultDisplay.classList.add(celebrationClass);
            resultDisplay.classList.remove('hidden');
            actionButton.classList.remove('hidden');
        }

        function updateActionButton() {
            if (lastRoundSuccess) {
                actionButton.textContent = (currentStageIndex === stages.length - 1) ? "Claim Victory!" : `Continue to Stage ${currentStageIndex + 2}`;
            } else {
                actionButton.textContent = "Try Again";
            }
        }

        function handleNextAction() {
            if (lastRoundSuccess) {
                currentStageIndex++;
            } else {
                currentStageIndex = 0;
            }
            setupNewRound();
        }
        
        function displayOverallWin() {
            stageDisplay.textContent = "Congratulations!";
            uiFeedback.classList.remove('hidden');
            targetDisplay.classList.remove('fading-out');
            progressContainer.classList.remove('fading-out');
            targetDisplay.textContent = "You Win!";
            instructions.innerHTML = "You have mastered the art of time. <br>Truly a Zen Master performance!";
            actionButton.textContent = "Play Again?";
            actionButton.classList.remove('hidden');
            lastRoundSuccess = false;
        }

        // Event Listeners
        gameContainer.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mouseup', handleMouseUp);
        gameContainer.addEventListener('touchstart', handleMouseDown, { passive: false });
        window.addEventListener('touchend', handleMouseUp);
        actionButton.addEventListener('click', handleNextAction);

        // Start the first round
        setupNewRound();
    </script>

</body>
</html>
